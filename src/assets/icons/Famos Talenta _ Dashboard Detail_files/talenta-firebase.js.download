firebaseInit();
load_notifications();

function firebaseInit() {
	const firebaseConfig = {
		apiKey: "AIzaSyA_hdwXRXB3BOgd84yJKa4FAWwxw67-MgM",
		authDomain: "famos-company.firebaseapp.com",
		projectId: "famos-company",
		storageBucket: "famos-company.appspot.com",
		messagingSenderId: "832656034096",
		appId: "1:832656034096:web:72039958e41cc2b7a4e0f5",
		measurementId: "G-QF9S6TQBFH"
	};

	firebase.initializeApp(firebaseConfig);
	firebase.analytics();
	Notification.requestPermission().then(function (permission) {
		console.log("permiss", permission);
	});
	const messaging = firebase.messaging();
	messaging.requestPermission()
		.then(function () {
			return messaging.getToken();
		})
		.then(function (tkn) {
			inputToken(tkn);
		})
		.catch(function (err) {
			console.log("Unable to get permission to notify.", err);
		});


	messaging.onMessage(function (response) {
		const noteTitle = response.notification.title;
		const noteOptions = {
			body: response.notification.body,
			icon: response.notification.icon,
		};
		// console.log(response);
		// if (response.data.type == 'message-talenta') {
		// 	var talenta_id = $("#talenta_id").val();
		// 	var brief_id = $("#brief_id").val();
		// 	listChat(brief_id, talenta_id);
		// 	var audio = new Audio(base_url + 'assets/back-end/sounds/msg_notif.wav');
		// } else if (response.data.type == 'timeline') {
		// 	if (second_uri == 'dashboard' && third_uri == 'detail') {
		// 		load_notifications();
		// 		window.location.reload();
		// 	}
		// } else {
			
		// 	load_notifications();

		// }
		if (response.data.type != 'message-talenta') {
			load_notifications();
		} else if (response.data.type == 'timeline') {
			if (second_uri == 'dashboard' && third_uri == 'detail') {
				load_notifications();
				window.location.reload();
			}
		} else {
			var client_id = $("#client_id").val();
			var brief_id = $("#brief_id").val();
			listChat(brief_id, client_id);
			var audio = new Audio(base_url + 'assets/back-end/sounds/msg_notif.wav');
			// audio.play();

		}
	});

}

function inputToken(token) {

	$.ajax({
		url: base_url + 'firebase/save_token_talentas',
		type: 'GET',
		dataType: 'json',
		data: {
			token: token
		},
		success: function (resp) {
			console.log(resp);
		}
	});

}

function load_notifications() {
	$.ajax({
		url: base_url + 'talentas/home/notif/',
		type: 'GET',
		dataType: 'JSON',
		success: function (resp) {
			if (resp.notif_head > 0) {
				var audio = new Audio(base_url + 'assets/back-end/sounds/client_notif.mp3');
				// audio.play();
				$("#notif_head").html('Pemberitahuan Baru (' + resp.notif_head + ') ');
				$("#loceng_icon").attr('src', base_url + 'assets/front-end/client-site/images/ic-head-notif.png')
			} else {
				if (resp.notif_head == 0 && resp.total_notif == 0) {
					$("#notif_head").html('Tidak ada pemberitahuan baru');
					$("#loceng_icon").attr('src', base_url + 'assets/front-end/client-site/images/ic-bell-black.png')
				} else {
					$("#notif_head").html('Pemberitahuan (' + resp.total_notif + ') ');
					$("#loceng_icon").attr('src', base_url + 'assets/front-end/client-site/images/ic-bell-black.png')
				}
			}
			$("#notif_box").html(resp.notif_data);
			$("#notif_box_mob").html(resp.notif_data);
		}
	});
}

$("#loceng_icon").click(function (event) {
	/* Act on the event */
	$.ajax({
		url: base_url + 'talentas/home/read_notif/',
		type: 'GET',
		dataType: 'JSON',
		success: function (resp) {
			load_notifications();
		}
	});
});
